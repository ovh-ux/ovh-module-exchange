<div class="px-5 pt-5" data-ui-view>
    <oui-back-button data-on-click="$ctrl.goBack()">
        <span data-translate="exchange_update_billing_action_title"></span>
    </oui-back-button>

    <oui-stepper
        data-on-finish="submit()">
        <oui-step-form
            data-header="{{::'exchange_update_billing_button_title' | translate}}"
            data-description="{{::'exchange_update_billing_periode_intro' | translate}}"
            data-loading="!$ctrl.exchange"
            data-on-cancel="$ctrl.goBack()"
            data-valid="hasChanged()"
            data-prevent-next>

            <oui-message class="mb-5"
                data-type="warning"
                data-ng-if="!$ctrl.loading && $ctrl.bufferedAccounts && $ctrl.bufferedAccounts.list.messages.length > 0">
                <strong data-translate="exchange_tab_ACCOUNTS_warning"></strong>
                <span data-translate="exchange_tab_ACCOUNTS_partial"></span>
                <ul class="mt-3">
                    <li data-ng-repeat="account in $ctrl.bufferedAccounts.list.messages | orderBy: 'id':false track by $index">
                        <strong data-ng-bind="account.id"></strong>: <span data-ng-bind="account.message"></span>
                    </li>
                </ul>
            </oui-message>

            <oui-datagrid class="mb-5"
                data-ng-if="$ctrl.exchange"
                data-rows-loader="$ctrl.retrieveAccounts($config)">
                <extra-top>
                    <oui-action-menu text="Actions">
                        <oui-action-menu-item
                            data-ng-click="$ctrl.checkboxStateChange('MONTHLY')">
                            <span data-translate="exchange_update_billing_periode_action"></span>
                            <strong data-translate="exchange_update_billing_periode_value_MONTHLY"></strong>
                        </oui-action-menu-item>
                        <oui-action-menu-item
                            data-ng-click="$ctrl.checkboxStateChange('YEARLY')">
                            <span data-translate="exchange_update_billing_periode_action"></span>
                            <strong data-translate="exchange_update_billing_periode_value_YEARLY"></strong>
                        </oui-action-menu-item>
                        <oui-action-menu-item
                            data-ng-click="$ctrl.checkboxStateChange('DELETE_AT_EXPIRATION')">
                            <span data-translate="exchange_update_billing_periode_action"></span>
                            <strong data-translate="exchange_update_billing_periode_value_DELETE_AT_EXPIRATION"></strong>
                        </oui-action-menu-item>
                    </oui-action-menu>
                </extra-top>

                <oui-column
                    data-title="::'exchange_tab_ACCOUNTS_table_email' | translate"
                    data-property="primaryEmailDisplayName"
                    data-type="string"
                    data-searchable>
                    <span class="word-break"
                        data-ng-bind="$row.primaryEmailDisplayName | wucSliceContent: 150">
                    </span>
                </oui-column>
                <oui-column
                    data-title="::'exchange_update_billing_expiration_date_label' | translate">
                    <span data-ng-bind="$row.expirationDate | date:'mediumDate'"></span>
                </oui-column>
                <oui-column
                    data-title="::'exchange_update_billing_header_1M' | translate">
                    <oui-radio name="renewPeriod-{{::$rowIndex}}"
                        data-ng-if="!$ctrl.account.partial && $ctrl.canHaveMonthlyRenewal()"
                        data-model="$row.renewPeriod"
                        data-on-change="$ctrl.trackSelected($row.primaryEmailAddress, $row.renewPeriod)"
                        data-value="'MONTHLY'">
                        {{::'exchange_update_billing_periode_value_MONTHLY' | translate}}
                    </oui-radio>
                </oui-column>
                <oui-column
                    data-title="::'exchange_update_billing_header_1Y' | translate">
                    <oui-radio name="renewPeriod-{{::$rowIndex}}"
                        data-ng-if="!$ctrl.account.partial"
                        data-model="$row.renewPeriod"
                        data-on-change="$ctrl.trackSelected($row.primaryEmailAddress, $row.renewPeriod)"
                        data-value="'YEARLY'">
                        {{::'exchange_update_billing_periode_value_YEARLY' | translate}}
                    </oui-radio>
                </oui-column>
                <oui-column
                    data-title="::'exchange_update_billing_header_terminate' | translate">
                    <oui-radio name="renewPeriod-{{::$rowIndex}}"
                        data-ng-if="!$ctrl.account.partial && $ctrl.canBeDeletedAtExpiration()"
                        data-model="$row.renewPeriod"
                        data-on-change="$ctrl.trackSelected($row.primaryEmailAddress, $row.renewPeriod)"
                        data-value="'DELETE_AT_EXPIRATION'">
                        {{::'exchange_update_billing_periode_value_DELETE_AT_EXPIRATION' | translate}}
                    </oui-radio>
                </oui-column>
            </oui-datagrid>

            <oui-message class="mb-5"
                data-type="warning"
                data-ng-if="$ctrl.canBeDeletedAtExpiration() && $ctrl.services.exchangeVersion.isAfter(2010, $ctrl.exchange) && !$ctrl.account.partial && $ctrl.model.displayDeleteWarning">
                <span data-translate="exchange_update_billing_periode_delete_warning"></span>
            </oui-message>
        </oui-step-form>

        <oui-step-form
            data-header="{{::'exchange_update_billing_validation_title' | translate}}"
            data-description="{{::'exchange_update_billing_periode_resume' | translate}}"
            data-loading="$ctrl.submitLoader">
            <div class="oui-datagrid-responsive-container" data-ng-if="!$ctrl.submitLoader">
                <div class="oui-datagrid-responsive-container__sticky-container">
                    <div class="oui-datagrid-responsive-container__overflow-container">
                        <table class="oui-datagrid">
                            <thead class="oui-datagrid__headers">
                                <tr>
                                    <th scope="col" data-translate="exchange_tab_ACCOUNTS_table_email" class="oui-datagrid__header"></th>
                                    <th class="text-center oui-datagrid__header" scope="col" data-translate="exchange_update_billing_header_new_periode"></th>
                                </tr>
                            </thead>

                            <tbody>
                                <tr class="oui-datagrid__row" data-ng-repeat="account in ($ctrl.bufferedAccounts.list.results | orderBy:'primaryEmailAddress':false) track by $index">
                                    <td data-ng-bind="account.primaryEmailDisplayName" class="oui-datagrid__cell"></td>
                                    <td class="text-center oui-datagrid__cell" data-ng-bind="('exchange_update_billing_periode_value_' + account.renewPeriod) | translate"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="alert alert-warning"
                role="alert"
                data-translate="exchange_update_billing_periode_delete_warning"
                data-ng-if="$ctrl.model.displayDeleteWarning">
            </div>
        </oui-step-form>
    </oui-stepper>
</div>
